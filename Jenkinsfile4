pipeline{
    agent any
    tools{
        maven 'myMaven'
        jdk 'myJava'
    }
    stages{
        stage("Compile"){
            steps{
              script{
                 echo "Compiling the code"
                
                 sh 'mvn compile'
              }
            }
        }
        stage("test"){
             steps{
                script{
                  echo "Testing the code"
                  sh 'mvn test'
                  }
             }
             
        }
        stage("Package"){
             steps{
                script{
                  echo "Packaging the code"
                  sh 'mvn package'
              }
             }
        }
        stage("Build the docker image"){
            steps{
                script{
                   
                    echo "Packaging the app"
                    withCredentials([usernamePassword(credentialsId: 'docker-hub', passwordVariable: 'PASSWORD', usernameVariable: 'USERNAME')])
                    {
                        echo "111"
                        sh "ssh -o StrictHostKeyChecking=no user1@172.31.17.205 exit"
                        echo "222"
                        sh "scp -o StrictHostKeyChecking=no server-script.sh user1@172.31.17.205:/home/ec2-user"
                        sh "ssh -o StrictHostKeyChecking=no ec2-user@172.31.17.205 'bash ~/server-script.sh'"
                        sh "sudo docker build -t priyankchheta/test-docker:$BUILD_NUMBER /home/ec2-user/addressbook"
                        sh "ssh user1@172.31.17.205 sudo docker login -u $USERNAME -p $PASSWORD"
                        sh "ssh user1@172.31.17.205 sudo docker push priyankchheta/test-docker:$BUILD_NUMBER"
                    }
                     
                    
                }
            }
        }
        stage("Deploy the docker container"){
            steps{
                script{
            echo "deploying the app"
            sh "ssh user1@172.31.17.205 sudo docker run -itd -P chhetapriyank/test-docker:$BUILD_NUMBER"
        }
            }
    }
}
}

